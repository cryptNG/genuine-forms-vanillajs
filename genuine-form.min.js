import {GenuineCaptcha as a} from'https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js';const{isArray:b}=Array;export default class GenuineForm extends HTMLElement{secret=null;solution=null;isVerifiedCaptcha=!1;timerId=null;gfApiUrl='https://genuine-forms.io/api/gf-send-dev/';handleSendResponse=new Map;handleStartSending=new Map;handleFinishedSending=new Map;handleValidationFailed=new Map;handleValidateForm=(_,B)=>A(_,B);handleInitialized=(c,C)=>console.log('Default handleInitialized:',c,C);generateSubjectAndBody=async (_a,_b,_c='Generic Subject')=>({subject:_c,body:JSON.stringify(f(_b)),payload:JSON.stringify(await g(_b))});constructor(){super();this.payload={};this.name=this.getAttribute('name')||'genuine-form';this.subject=this.getAttribute('subject')||'Generic Subject';this._apiKey=this.getAttribute('api-key');this.receiver=this.getAttribute('receiver');this.gfApiUrl=this.getAttribute('api-url')||this.gfApiUrl;this.abortController=new AbortController;this.genuineCaptchaNode=null;this.events={on:(_A,E)=>{let aA=async (...aB)=>{try{await E(...aB)}catch(aC){console.error(`Error in ${_A} handler:`,aC)}};_A==='send-response'&&this.handleSendResponse.set(E,aA);_A==='started-sending'&&this.handleStartSending.set(E,aA);_A==='finished-sending'&&this.handleFinishedSending.set(E,aA);_A==='validation-failed'&&this.handleValidationFailed.set(E,aA)},off:(aD,aE)=>{aD==='send-response'&&this.handleSendResponse.delete(aE);aD==='started-sending'&&this.handleStartSending.delete(aE);aD==='finished-sending'&&this.handleFinishedSending.delete(aE);aD==='validation-failed'&&this.handleValidationFailed.delete(aE)},call:(aF,...aG)=>{aF==='set-payload'&&this.setPlayload(...aG);aF==='unset-payload'&&this.unsetPlayload(...aG)}};!window.genuineForms&&(window.genuineForms={});let D=document.getElementById('genuine-form'),_C=document.createElement('style');if(!D){console.error('Template #genuine-form not found');return}let _B=D.content;this.attachShadow({mode:'open'});_C.textContent=`
          :host{
            --form-display:flex;
            --form-flex-direction:column;
            --form-gap:1rem;
            --form-padding:1rem;
            --form-border-radius:0.5rem;
            --form-border:1px solid #ccc;
            --form-background:transparent;
            --form-box-shadow:0 2px 4px rgba(0,0,0,0.1);
      
          }

          .genuine-form-container{
            display: var(--form-display);
            position: relative;
            flex-direction:  var(--form-flex-direction);
            gap: var(--form-gap);
            background:var(--form-background);
            border-radius: var(--form-border-radius);
          }
      `;this.shadowRoot.appendChild(_C);this.shadowRoot.appendChild(_B.cloneNode(!0));this.setupCaptchaHandlerRegistry();this.hooksReady=Promise.all([this.registerHandleValidateForm(),this.registerGenerateSubjectAndBody(),this.registerHandleInitialized()])}setPlayload(aH,aI){this.payload[aH]=aI}unsetPlayload(aJ){delete this.payload[aJ]}setupCaptchaHandlerRegistry(){if(!window._genuineFormHandlers){window._genuineFormHandlers=new Map;let aK=window.genuineCaptchaHandleVerify;window.genuineCaptchaHandleVerify=(aL,aM,aN)=>{for(const aO of window._genuineFormHandlers)aO(aL,aM,aN);aK&&aK(aL,aM,aN)}}this.myHandleVerify=(aP,aQ,aR)=>{aP===this.name&&(console.log('CAPTCHA verified for form:',aP),this.isVerifiedCaptcha=!0,this.solution=aQ,this.secret=aR)};if(!window._genuineFormResetHandlers){window._genuineFormResetHandlers=new Map;let aS=window.genuineCaptchaReset;window.genuineCaptchaReset=aT=>{for(const aU of window._genuineFormResetHandlers)aU(aT);aS&&aS(aT)}}this.myHandleReset=aV=>{aV===this.name&&(console.log('CAPTCHA reset for form:',aV),this.isVerifiedCaptcha=!1,this.solution='',this.secret='')}}connectedCallback(){window.genuineForms[this.name]=this.events;(async ()=>await this.handleInitialized(this.name,this))();window._genuineFormHandlers?.set(this.name,this.myHandleVerify);window._genuineFormResetHandlers?.set(this.name,this.myHandleReset);this.setupObserver=new MutationObserver(()=>{!this.submitButton&&this.setupSubmitButton();!this.genuineCaptchaNode&&this.findCaptchaNode()});this.setupObserver.observe(this,{childList:!0,subtree:!0});this.setupTimeout=setTimeout(async ()=>{this.setupSubmitButton();await this.setupCaptcha()},100)}disconnectedCallback(){this.setupTimeout&&(clearTimeout(this.setupTimeout),this.setupTimeout=null);this.timerId&&(clearTimeout(this.timerId),this.timerId=null);this.abortController&&(this.abortController.abort(),this.abortController=null);(this.submitButton&&this.submitHandler)&&(this.submitButton.removeEventListener('click',this.submitHandler),this.submitButton=null,this.submitHandler=null);this.setupObserver&&(this.setupObserver.disconnect(),this.setupObserver=null);window.genuineForms?.[this.name]&&delete window.genuineForms[this.name];window._genuineFormHandlers?.delete(this.name);window._genuineFormResetHandlers?.delete(this.name)}setupSubmitButton(){let aW=this.querySelectorAll('[type="submit"]');aW.length>1&&console.warn(`Multiple submit buttons found in genuine-form[name="${this.name}"], only the first one will be used.`);(aW[0]&&!this.submitButton)&&(this.submitButton=aW[0],this.submitHandler=aX=>{aX.preventDefault();aX.stopPropagation();if(!this.isValidForm){for(const aY of this.handleValidationFailed)aY();return}this.sendForm(aX)},this.submitButton.addEventListener('click',this.submitHandler))}async setupCaptcha(){await this.findCaptchaNode();this.genuineCaptchaNode?this.genuineCaptchaNode.setAttribute('name',this.name):console.error(`Missing <genuine-captcha> web component in genuine-form[name="${this.name}"]`)}async findCaptchaNode(){return new Promise(aZ=>{let bA=()=>{let bB=this.shadowRoot.querySelector('slot');if(!bB){aZ(null);return}let bC=bB.assignedNodes();for(const bD of bC){if(bD.nodeName==='GENUINE-CAPTCHA'){this.genuineCaptchaNode=bD;aZ(bD);return}if(bD.nodeType===Node.ELEMENT_NODE){let bE=bD.querySelector('genuine-captcha');if(bE){this.genuineCaptchaNode=bE;aZ(bE);return}}}aZ(null)};if(this.genuineCaptchaNode){aZ(this.genuineCaptchaNode);return}bA();!this.genuineCaptchaNode&&setTimeout(()=>bA(),100)})}registerHandleValidateForm=async ()=>{let bF=0;while(window.genuineFormHandleValidate===void 0&&bF<20){bF++;await d(100)}this.handleValidateForm=window.genuineFormHandleValidate||this.handleValidateForm};registerHandleInitialized=async ()=>{let bG=0;while(window.genuineFormHandleInitialized===void 0&&bG<20){bG++;await d(100)}this.handleInitialized=window.genuineFormHandleInitialized||this.handleInitialized};registerGenerateSubjectAndBody=async ()=>{let bH=0;while(window.genuineFormGenerateSubjectAndBody===void 0&&bH<20){bH++;await d(100)}this.generateSubjectAndBody=window.genuineFormGenerateSubjectAndBody||this.generateSubjectAndBody};get isValidForm(){return this.handleValidateForm(this.name,this)}static get observedAttributes(){return['subject','receiver','api-key','name','api-url']}attributeChangedCallback(bI,bJ,bK){bI==='subject'&&(this.subject=bK);bI==='receiver'&&(this.receiver=bK);bI==='api-key'&&(this._apiKey=bK);bI==='api-url'&&(this.gfApiUrl=bK);bI==='name'&&(this.name=bK)}get apiKey(){return this._apiKey||this.receiver}sendForm=async bL=>{bL.preventDefault();if(this.isSending){console.log('Form submission already in progress');return}if(!this.isVerifiedCaptcha||!this.isValidForm||this.apiKey===''){console.log('Form not valid or Captcha not verified or no receiver/api-key set.');return}await this.hooksReady;const{subject:bM,body:bN,payload:_d}=await this.generateSubjectAndBody(this.name,this,this.subject);if(bM.length>200){console.error('Subject too long (max 200 characters)');for(const bO of this.handleSendResponse)bO({ok:!1,error:'Subject too long'});return}this.isSending=!0;this.setAttribute('data-sending','');this.submitButton&&(this.submitButton.disabled=!0);try{this.abortController?.abort();this.abortController=new AbortController;for(const bQ of this.handleStartSending)bQ();let bP=await fetch(this.gfApiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({captchaSolution:this.solution,captchaSecret:this.secret,apiKey:this.apiKey,subject:bM,body:bN,payload:_d}),signal:this.abortController.signal});if(bP.ok){let bR=await bP.json();if(!bR||typeof bR!=='object')throw Error('Invalid response format');console.log('Success:',bR.body||bR);for(const bS of this.handleSendResponse)bS({ok:!0,body:bR.body||bR});this.dispatchEvent(new CustomEvent('form-submit-success', {detail:{body:bR.body||bR},bubbles:!0,composed:!0}));this.resetForm()}else{let bT=await bP.text();for(const bU of this.handleSendResponse)bU({ok:!1,status:bP.status,error:`${bT}`});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:`Server error: ${bP.status}`},bubbles:!0,composed:!0}))}}catch(bV){if(bV.name==='AbortError'){console.log('Form submission aborted');return}console.error('Error:',bV);for(const bW of this.handleSendResponse)bW({ok:!1,error:bV.message||'Unknown error'});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:bV.message},bubbles:!0,composed:!0}))}finally{this.isSending=!1;this.removeAttribute('data-sending');this.submitButton&&(this.submitButton.disabled=!1);for(const bX of this.handleFinishedSending)bX()}};resetForm(){this.isVerifiedCaptcha=!1;this.solution=this.secret='';let bY=this.shadowRoot.querySelector('form');bY?.reset();(this.genuineCaptchaNode&&typeof this.genuineCaptchaNode.loadCaptcha==='function')&&this.genuineCaptchaNode.loadCaptcha()}}function d(bZ){return new Promise(cA=>setTimeout(cA,bZ))}if(typeof document!=='undefined')if(!customElements.get('genuine-form')){let cB=()=>{if(!document.getElementById('genuine-form')){let cC=document.createElement('template');cC.id='genuine-form';cC.innerHTML=`<script type="module" src="https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js" defer></script>
        <form class="genuine-form-container">
          <slot></slot>
        </form>`;document.body?document.body.prepend(cC):document.addEventListener('DOMContentLoaded',()=>{(document.body&&!document.getElementById('genuine-form'))&&document.body.prepend(cC)})}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',cB):cB();customElements.define('genuine-form',GenuineForm)}function A(cD,cE){let cF=cE.querySelectorAll('input[required], select[required], textarea[required]');for(let cG of cF)if(cG.tagName==='INPUT'){let cH=cG.type.toLowerCase();if(cH==='email')if(!cG.checkValidity())return!1;else if(cH==='checkbox')if(!cG.checked)return!1;else if(cH==='radio'){let cI=cE.querySelectorAll(`input[type="radio"][name="${cG.name}"]`),cJ=[...cI].some(cK=>cK.checked);if(!cJ)return!1}else if(!cG.value.trim())return!1}else if(cG.tagName==='SELECT')if(cG.multiple)if(cG.selectedOptions.length===0)return!1;else if(!cG.value)return!1;else if(cG.tagName==='TEXTAREA')if(!cG.value.trim())return!1;let _D=cE.querySelectorAll('.required:has(input[type=checkbox])');for(let cL of _D)if(!cL.querySelector('input[type=checkbox]:checked'))return!1;return!0}function f(cM){let cN={},cO=cM.querySelectorAll('input, select, textarea');for(const cP of cO){let cQ=cP.name;if(!cQ)continue;let cR;if(cP.tagName==='INPUT'){if(cP.type==='file')continue;if(cP.type==='checkbox')cR=(cP.value||'').length>0?(cP.value+':'+cP.checked):cP.checked;else if(cP.type==='radio')if(cP.checked)cR=cP.value;else continue;else cR=cP.value}else if(cP.tagName==='SELECT')cP.multiple?cR=[...cP.selectedOptions].map(opt=>opt.value):cR=cP.value;else cR=cP.value;if(cN.hasOwnProperty(cQ)){!b(cN[cQ])&&(cN[cQ]=[cN[cQ]]);cN[cQ].push(cR)}else cN[cQ]=cR}return cN}async function g(cS){let cT={},cU=cS.querySelectorAll('input[type="file"]');await Promise.all([...cU].map(async cV=>{let cW=cV.name;if(!cW)return;let cX;if(cV.tagName==='INPUT')if(cV.type==='file'&&cV.files[0]){let cY=await new Promise((cZ,dA)=>{let dB='';let dC=new FileReader;dC.onloadend=e=>{dB=e.target.result;cZ(dB.replace('data:','').replace(/^.+,/,''))};dC.onerror=e=>dA(e);dC.readAsDataURL(cV.files[0])});console.log(cY);cT[cW]={type:'file',fileType:cV.files[0].type,fileName:cV.files[0].name,content64:cY}}}));return{...cT,...cS.payload}}export{GenuineForm};
