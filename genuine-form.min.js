import {GenuineCaptcha as a} from'https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js';const{isArray:b}=Array;export default class GenuineForm extends HTMLElement{secret=null;solution=null;isVerifiedCaptcha=!1;timerId=null;gfApiUrl='https://genuine-forms.io/api/gf-send-dev/';handleSendResponse=new Map;handleStartSending=new Map;handleFinishedSending=new Map;handleValidationFailed=new Map;handleValidateForm=(_,B)=>A(_,B);handleInitialized=(c,C)=>console.log('Default handleInitialized:',c,C);generateSubjectAndBody=async (_a,_b,_c='Generic Subject')=>({subject:_c,body:JSON.stringify(f(_b)),payload:JSON.stringify(await g(_b))});constructor(){super();this.name=this.getAttribute('name')||'genuine-form';this.subject=this.getAttribute('subject')||'Generic Subject';this._apiKey=this.getAttribute('api-key');this.receiver=this.getAttribute('receiver');this.gfApiUrl=this.getAttribute('api-url')||this.gfApiUrl;this.abortController=new AbortController;this.genuineCaptchaNode=null;this.events={on:(_A,E)=>{let aA=async (...aB)=>{try{await E(...aB)}catch(aC){console.error(`Error in ${_A} handler:`,aC)}};_A==='send-response'&&this.handleSendResponse.set(E,aA);_A==='started-sending'&&this.handleStartSending.set(E,aA);_A==='finished-sending'&&this.handleFinishedSending.set(E,aA);_A==='validation-failed'&&this.handleValidationFailed.set(E,aA)},off:(aD,aE)=>{aD==='send-response'&&this.handleSendResponse.delete(aE);aD==='started-sending'&&this.handleStartSending.delete(aE);aD==='finished-sending'&&this.handleFinishedSending.delete(aE);aD==='validation-failed'&&this.handleValidationFailed.delete(aE)}};!window.genuineForms&&(window.genuineForms={});let D=document.getElementById('genuine-form'),_C=document.createElement('style');if(!D){console.error('Template #genuine-form not found');return}let _B=D.content;this.attachShadow({mode:'open'});_C.textContent=`
          :host{
            --form-display:flex;
            --form-flex-direction:column;
            --form-gap:1rem;
            --form-padding:1rem;
            --form-border-radius:0.5rem;
            --form-border:1px solid #ccc;
            --form-background:transparent;
            --form-box-shadow:0 2px 4px rgba(0,0,0,0.1);
      
          }

          .genuine-form-container{
            display: var(--form-display);
            position: relative;
            flex-direction:  var(--form-flex-direction);
            gap: var(--form-gap);
            background:var(--form-background);
            border-radius: var(--form-border-radius);
          }
      `;this.shadowRoot.appendChild(_C);this.shadowRoot.appendChild(_B.cloneNode(!0));this.setupCaptchaHandlerRegistry();this.hooksReady=Promise.all([this.registerHandleValidateForm(),this.registerGenerateSubjectAndBody(),this.registerHandleInitialized()])}setupCaptchaHandlerRegistry(){if(!window._genuineFormHandlers){window._genuineFormHandlers=new Map;let aF=window.genuineCaptchaHandleVerify;window.genuineCaptchaHandleVerify=(aG,aH,aI)=>{for(const aJ of window._genuineFormHandlers)aJ(aG,aH,aI);aF&&aF(aG,aH,aI)}}this.myHandleVerify=(aK,aL,aM)=>{aK===this.name&&(console.log('CAPTCHA verified for form:',aK),this.isVerifiedCaptcha=!0,this.solution=aL,this.secret=aM)};if(!window._genuineFormResetHandlers){window._genuineFormResetHandlers=new Map;let aN=window.genuineCaptchaReset;window.genuineCaptchaReset=aO=>{for(const aP of window._genuineFormResetHandlers)aP(aO);aN&&aN(aO)}}this.myHandleReset=aQ=>{aQ===this.name&&(console.log('CAPTCHA reset for form:',aQ),this.isVerifiedCaptcha=!1,this.solution='',this.secret='')}}connectedCallback(){window.genuineForms[this.name]=this.events;(async ()=>await this.handleInitialized(this.name,this))();window._genuineFormHandlers?.set(this.name,this.myHandleVerify);window._genuineFormResetHandlers?.set(this.name,this.myHandleReset);this.setupObserver=new MutationObserver(()=>{!this.submitButton&&this.setupSubmitButton();!this.genuineCaptchaNode&&this.findCaptchaNode()});this.setupObserver.observe(this,{childList:!0,subtree:!0});this.setupTimeout=setTimeout(async ()=>{this.setupSubmitButton();await this.setupCaptcha()},100)}disconnectedCallback(){this.setupTimeout&&(clearTimeout(this.setupTimeout),this.setupTimeout=null);this.timerId&&(clearTimeout(this.timerId),this.timerId=null);this.abortController&&(this.abortController.abort(),this.abortController=null);(this.submitButton&&this.submitHandler)&&(this.submitButton.removeEventListener('click',this.submitHandler),this.submitButton=null,this.submitHandler=null);this.setupObserver&&(this.setupObserver.disconnect(),this.setupObserver=null);window.genuineForms?.[this.name]&&delete window.genuineForms[this.name];window._genuineFormHandlers?.delete(this.name);window._genuineFormResetHandlers?.delete(this.name)}setupSubmitButton(){let aR=this.querySelectorAll('[type="submit"]');aR.length>1&&console.warn(`Multiple submit buttons found in genuine-form[name="${this.name}"], only the first one will be used.`);(aR[0]&&!this.submitButton)&&(this.submitButton=aR[0],this.submitHandler=aS=>{aS.preventDefault();aS.stopPropagation();if(!this.isValidForm){for(const aT of this.handleValidationFailed)aT();return}this.sendForm(aS)},this.submitButton.addEventListener('click',this.submitHandler))}async setupCaptcha(){await this.findCaptchaNode();this.genuineCaptchaNode?this.genuineCaptchaNode.setAttribute('name',this.name):console.error(`Missing <genuine-captcha> web component in genuine-form[name="${this.name}"]`)}async findCaptchaNode(){return new Promise(aU=>{let aV=()=>{let aW=this.shadowRoot.querySelector('slot');if(!aW){aU(null);return}let aX=aW.assignedNodes();for(const aY of aX){if(aY.nodeName==='GENUINE-CAPTCHA'){this.genuineCaptchaNode=aY;aU(aY);return}if(aY.nodeType===Node.ELEMENT_NODE){let aZ=aY.querySelector('genuine-captcha');if(aZ){this.genuineCaptchaNode=aZ;aU(aZ);return}}}aU(null)};if(this.genuineCaptchaNode){aU(this.genuineCaptchaNode);return}aV();!this.genuineCaptchaNode&&setTimeout(()=>aV(),100)})}registerHandleValidateForm=async ()=>{let bA=0;while(window.genuineFormHandleValidate===void 0&&bA<20){bA++;await d(100)}this.handleValidateForm=window.genuineFormHandleValidate||this.handleValidateForm};registerHandleInitialized=async ()=>{let bB=0;while(window.genuineFormHandleInitialized===void 0&&bB<20){bB++;await d(100)}this.handleInitialized=window.genuineFormHandleInitialized||this.handleInitialized};registerGenerateSubjectAndBody=async ()=>{let bC=0;while(window.genuineFormGenerateSubjectAndBody===void 0&&bC<20){bC++;await d(100)}this.generateSubjectAndBody=window.genuineFormGenerateSubjectAndBody||this.generateSubjectAndBody};get isValidForm(){return this.handleValidateForm(this.name,this)}static get observedAttributes(){return['subject','receiver','api-key','name','api-url']}attributeChangedCallback(bD,bE,bF){bD==='subject'&&(this.subject=bF);bD==='receiver'&&(this.receiver=bF);bD==='api-key'&&(this._apiKey=bF);bD==='api-url'&&(this.gfApiUrl=bF);bD==='name'&&(this.name=bF)}get apiKey(){return this._apiKey||this.receiver}sendForm=async bG=>{bG.preventDefault();if(this.isSending){console.log('Form submission already in progress');return}if(!this.isVerifiedCaptcha||!this.isValidForm||this.apiKey===''){console.log('Form not valid or Captcha not verified or no receiver/api-key set.');return}await this.hooksReady;const{subject:bH,body:bI,payload:_d}=await this.generateSubjectAndBody(this.name,this,this.subject);if(bH.length>200){console.error('Subject too long (max 200 characters)');for(const bJ of this.handleSendResponse)bJ({ok:!1,error:'Subject too long'});return}this.isSending=!0;this.setAttribute('data-sending','');this.submitButton&&(this.submitButton.disabled=!0);try{this.abortController?.abort();this.abortController=new AbortController;for(const bL of this.handleStartSending)bL();let bK=await fetch(this.gfApiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({captchaSolution:this.solution,captchaSecret:this.secret,apiKey:this.apiKey,subject:bH,body:bI,payload:_d}),signal:this.abortController.signal});if(bK.ok){let bM=await bK.json();if(!bM||typeof bM!=='object')throw Error('Invalid response format');console.log('Success:',bM.body||bM);for(const bN of this.handleSendResponse)bN({ok:!0,body:bM.body||bM});this.dispatchEvent(new CustomEvent('form-submit-success', {detail:{body:bM.body||bM},bubbles:!0,composed:!0}));this.resetForm()}else{let bO=await bK.text();for(const bP of this.handleSendResponse)bP({ok:!1,status:bK.status,error:`${bO}`});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:`Server error: ${bK.status}`},bubbles:!0,composed:!0}))}}catch(bQ){if(bQ.name==='AbortError'){console.log('Form submission aborted');return}console.error('Error:',bQ);for(const bR of this.handleSendResponse)bR({ok:!1,error:bQ.message||'Unknown error'});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:bQ.message},bubbles:!0,composed:!0}))}finally{this.isSending=!1;this.removeAttribute('data-sending');this.submitButton&&(this.submitButton.disabled=!1);for(const bS of this.handleFinishedSending)bS()}};resetForm(){this.isVerifiedCaptcha=!1;this.solution=this.secret='';let bT=this.shadowRoot.querySelector('form');bT?.reset();(this.genuineCaptchaNode&&typeof this.genuineCaptchaNode.loadCaptcha==='function')&&this.genuineCaptchaNode.loadCaptcha()}}function d(bU){return new Promise(bV=>setTimeout(bV,bU))}if(typeof document!=='undefined')if(!customElements.get('genuine-form')){let bW=()=>{if(!document.getElementById('genuine-form')){let bX=document.createElement('template');bX.id='genuine-form';bX.innerHTML=`<script type="module" src="https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js" defer></script>
        <form class="genuine-form-container">
          <slot></slot>
        </form>`;document.body?document.body.prepend(bX):document.addEventListener('DOMContentLoaded',()=>{(document.body&&!document.getElementById('genuine-form'))&&document.body.prepend(bX)})}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',bW):bW();customElements.define('genuine-form',GenuineForm)}function A(bY,bZ){let cA=bZ.querySelectorAll('input[required], select[required], textarea[required],.required input[type=checkbox]');for(let cB of cA)if(cB.tagName==='INPUT'){let cC=cB.type.toLowerCase();if(cC==='email')if(!cB.checkValidity())return!1;else if(cC==='checkbox')if(!cB.checked)return!1;else if(cC==='radio'){let cD=bZ.querySelectorAll(`input[type="radio"][name="${cB.name}"]`),cE=[...cD].some(cF=>cF.checked);if(!cE)return!1}else if(!cB.value.trim())return!1}else if(cB.tagName==='SELECT')if(cB.multiple)if(cB.selectedOptions.length===0)return!1;else if(!cB.value)return!1;else if(cB.tagName==='TEXTAREA')if(!cB.value.trim())return!1;return!0}function f(cG){let cH={},cI=cG.querySelectorAll('input, select, textarea');for(const cJ of cI){let cK=cJ.name;if(!cK)continue;let cL;if(cJ.tagName==='INPUT'){if(cJ.type==='file')continue;if(cJ.type==='checkbox')cL=(cJ.value||'').length>0?(cJ.value+':'+cJ.checked):cJ.checked;else if(cJ.type==='radio')if(cJ.checked)cL=cJ.value;else continue;else cL=cJ.value}else if(cJ.tagName==='SELECT')cJ.multiple?cL=[...cJ.selectedOptions].map(opt=>opt.value):cL=cJ.value;else cL=cJ.value;if(cH.hasOwnProperty(cK)){!b(cH[cK])&&(cH[cK]=[cH[cK]]);cH[cK].push(cL)}else cH[cK]=cL}return cH}async function g(cM){let cN={},cO=cM.querySelectorAll('input[type="file"]');await Promise.all([...cO].map(async cP=>{let cQ=cP.name;if(!cQ)return;let cR;if(cP.tagName==='INPUT')if(cP.type==='file'&&cP.files[0]){let cS=await new Promise((cT,cU)=>{let cV='';let _D=new FileReader;_D.onloadend=e=>{cV=e.target.result;cT(cV.replace('data:','').replace(/^.+,/,''))};_D.onerror=e=>cU(e);_D.readAsDataURL(cP.files[0])});console.log(cS);cN[cQ]={type:'file',fileType:cP.files[0].type,fileName:cP.files[0].name,content64:cS}}}));return cN}export{GenuineForm};
