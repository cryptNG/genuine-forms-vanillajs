import {GenuineCaptcha as a} from'https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js';const{isArray:b}=Array;export default class GenuineForm extends HTMLElement{secret=null;solution=null;isVerifiedCaptcha=!1;timerId=null;gfApiUrl=`https://genuine-forms.io/api/gf-send-dev/`;handleSendResponse=new Map;handleStartSending=new Map;handleFinishedSending=new Map;handleValidationFailed=new Map;handleValidateForm=(A,_)=>e(A,_);handleInitialized=(B,c)=>console.log('Default handleInitialized:',B,c);generateSubjectAndBody=(C,_b,_c='Generic Subject')=>({subject:_c,body:JSON.stringify(f(_b))});constructor(){super();this.name=this.getAttribute('name')||'genuine-form';this.subject=this.getAttribute('subject')||'Generic Subject';this._apiKey=this.getAttribute('api-key');this.receiver=this.getAttribute('receiver');this.gfApiUrl=this.getAttribute('api-url')||this.gfApiUrl;this.abortController=new AbortController;this.genuineCaptchaNode=null;this.events={on:(_A,_B)=>{let E=async (...aA)=>{try{await _B(...aA)}catch(aB){console.error(`Error in ${_A} handler:`,aB)}};_A==='send-response'&&this.handleSendResponse.set(_B,E);_A==='started-sending'&&this.handleStartSending.set(_B,E);_A==='finished-sending'&&this.handleFinishedSending.set(_B,E);_A==='validation-failed'&&this.handleValidationFailed.set(_B,E)},off:(aC,aD)=>{aC==='send-response'&&this.handleSendResponse.delete(aD);aC==='started-sending'&&this.handleStartSending.delete(aD);aC==='finished-sending'&&this.handleFinishedSending.delete(aD);aC==='validation-failed'&&this.handleValidationFailed.delete(aD)}};!window.genuineForms&&(window.genuineForms={});let _a=document.getElementById('genuine-form'),_C=document.createElement('style');if(!_a){console.error('Template #genuine-form not found');return}let D=_a.content;this.attachShadow({mode:'open'});_C.textContent=`
          :host{
            --form-display:flex;
            --form-flex-direction:column;
            --form-gap:1rem;
            --form-padding:1rem;
            --form-border-radius:0.5rem;
            --form-border:1px solid #ccc;
            --form-background-color:transparent;
            --form-box-shadow:0 2px 4px rgba(0,0,0,0.1);
      
          }

          .genuine-form-container{
            display: var(--form-display);
            position: relative;
            flex-direction:  var(--form-flex-direction);
            gap: var(--form-gap);
            background-color:var(--form-background-color);
          }
      `;this.shadowRoot.appendChild(_C);this.shadowRoot.appendChild(D.cloneNode(!0));this.setupCaptchaHandlerRegistry();this.hooksReady=Promise.all([this.registerHandleValidateForm(),this.registerGenerateSubjectAndBody(),this.registerHandleInitialized()])}setupCaptchaHandlerRegistry(){if(!window._genuineFormHandlers){window._genuineFormHandlers=new Map;let aE=window.genuineCaptchaHandleVerify;window.genuineCaptchaHandleVerify=(aF,aG,aH)=>{for(const aI of window._genuineFormHandlers)aI(aF,aG,aH);aE&&aE(aF,aG,aH)}}this.myHandleVerify=(aJ,aK,aL)=>{aJ===this.name&&(console.log('CAPTCHA verified for form:',aJ),this.isVerifiedCaptcha=!0,this.solution=aK,this.secret=aL)};if(!window._genuineFormResetHandlers){window._genuineFormResetHandlers=new Map;let aM=window.genuineCaptchaReset;window.genuineCaptchaReset=aN=>{for(const aO of window._genuineFormResetHandlers)aO(aN);aM&&aM(aN)}}this.myHandleReset=aP=>{aP===this.name&&(console.log('CAPTCHA reset for form:',aP),this.isVerifiedCaptcha=!1,this.solution='',this.secret='')}}connectedCallback(){window.genuineForms[this.name]=this.events;(async ()=>await this.handleInitialized(this.name,this))();window._genuineFormHandlers?.set(this.name,this.myHandleVerify);window._genuineFormResetHandlers?.set(this.name,this.myHandleReset);this.setupObserver=new MutationObserver(()=>{!this.submitButton&&this.setupSubmitButton();!this.genuineCaptchaNode&&this.findCaptchaNode()});this.setupObserver.observe(this,{childList:!0,subtree:!0});this.setupTimeout=setTimeout(async ()=>{this.setupSubmitButton();await this.setupCaptcha()},100)}disconnectedCallback(){this.setupTimeout&&(clearTimeout(this.setupTimeout),this.setupTimeout=null);this.timerId&&(clearTimeout(this.timerId),this.timerId=null);this.abortController&&(this.abortController.abort(),this.abortController=null);(this.submitButton&&this.submitHandler)&&(this.submitButton.removeEventListener('click',this.submitHandler),this.submitButton=null,this.submitHandler=null);this.setupObserver&&(this.setupObserver.disconnect(),this.setupObserver=null);window.genuineForms?.[this.name]&&delete window.genuineForms[this.name];window._genuineFormHandlers?.delete(this.name);window._genuineFormResetHandlers?.delete(this.name)}setupSubmitButton(){let aQ=this.querySelectorAll('[type="submit"]');aQ.length>1&&console.warn(`Multiple submit buttons found in genuine-form[name="${this.name}"], only the first one will be used.`);(aQ[0]&&!this.submitButton)&&(this.submitButton=aQ[0],this.submitHandler=aR=>{aR.preventDefault();aR.stopPropagation();if(!this.isValidForm){for(const aS of this.handleValidationFailed)aS();return}this.sendForm(aR)},this.submitButton.addEventListener('click',this.submitHandler))}async setupCaptcha(){await this.findCaptchaNode();this.genuineCaptchaNode?this.genuineCaptchaNode.setAttribute('name',this.name):console.error(`Missing <genuine-captcha> web component in genuine-form[name="${this.name}"]`)}async findCaptchaNode(){return new Promise(aT=>{let aU=()=>{let aV=this.shadowRoot.querySelector('slot');if(!aV){aT(null);return}let aW=aV.assignedNodes();for(const aX of aW){if(aX.nodeName==='GENUINE-CAPTCHA'){this.genuineCaptchaNode=aX;aT(aX);return}if(aX.nodeType===Node.ELEMENT_NODE){let aY=aX.querySelector('genuine-captcha');if(aY){this.genuineCaptchaNode=aY;aT(aY);return}}}aT(null)};if(this.genuineCaptchaNode){aT(this.genuineCaptchaNode);return}aU();!this.genuineCaptchaNode&&setTimeout(()=>aU(),100)})}registerHandleValidateForm=async ()=>{let aZ=0;while(window.genuineFormHandleValidate===void 0&&aZ<150){aZ++;await d(100)}this.handleValidateForm=window.genuineFormHandleValidate||this.handleValidateForm};registerHandleInitialized=async ()=>{let bA=0;while(window.genuineFormHandleInitialized===void 0&&bA<150){bA++;await d(100)}this.handleInitialized=window.genuineFormHandleInitialized||this.handleInitialized};registerGenerateSubjectAndBody=async ()=>{let bB=0;while(window.genuineFormGenerateSubjectAndBody===void 0&&bB<150){bB++;await d(100)}this.generateSubjectAndBody=window.genuineFormGenerateSubjectAndBody||this.generateSubjectAndBody};get isValidForm(){return this.handleValidateForm(this.name,this)}static get observedAttributes(){return['subject','receiver','api-key','name','api-url']}attributeChangedCallback(bC,bD,bE){bC==='subject'&&(this.subject=bE);bC==='receiver'&&(this.receiver=bE);bC==='api-key'&&(this._apiKey=bE);bC==='api-url'&&(this.gfApiUrl=bE);bC==='name'&&(this.name=bE)}get apiKey(){return this._apiKey||this.receiver}sendForm=async bF=>{bF.preventDefault();if(this.isSending){console.log('Form submission already in progress');return}if(!this.isVerifiedCaptcha||!this.isValidForm||this.apiKey===''){console.log('Form not valid or Captcha not verified or no receiver/api-key set.');return}await this.hooksReady;const{subject:bG,body:bH}=this.generateSubjectAndBody(this.name,this,this.subject);if(bG.length>200){console.error('Subject too long (max 200 characters)');for(const bI of this.handleSendResponse)bI({ok:!1,error:'Subject too long'});return}this.isSending=!0;this.setAttribute('data-sending','');this.submitButton&&(this.submitButton.disabled=!0);try{this.abortController?.abort();this.abortController=new AbortController;await Promise.all(this.handleStartSending.map(bK=>bK()));let bJ=await fetch(this.gfApiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({captchaSolution:this.solution,captchaSecret:this.secret,apiKey:this.apiKey,subject:bG,body:bH}),signal:this.abortController.signal});if(bJ.ok){let bL=await bJ.json();if(!bL||typeof bL!=='object')throw Error('Invalid response format');console.log('Success:',bL.body||bL);for(const bM of this.handleSendResponse)bM({ok:!0,body:bL.body||bL});this.dispatchEvent(new CustomEvent('form-submit-success', {detail:{body:bL.body||bL},bubbles:!0,composed:!0}));this.resetForm()}else{let bN=await bJ.text();for(const bO of this.handleSendResponse)bO({ok:!1,status:bJ.status,error:`${bN}`});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:`Server error: ${bJ.status}`},bubbles:!0,composed:!0}))}}catch(bP){if(bP.name==='AbortError'){console.log('Form submission aborted');return}console.error('Error:',bP);for(const bQ of this.handleSendResponse)bQ({ok:!1,error:bP.message||'Unknown error'});this.dispatchEvent(new CustomEvent('form-submit-error', {detail:{error:bP.message},bubbles:!0,composed:!0}))}finally{this.isSending=!1;this.removeAttribute('data-sending');this.submitButton&&(this.submitButton.disabled=!1);await Promise.all(this.handleFinishedSending.map(bR=>bR()))}};resetForm(){this.isVerifiedCaptcha=!1;this.solution=this.secret='';let bS=this.shadowRoot.querySelector('form');bS?.reset();(this.genuineCaptchaNode&&typeof this.genuineCaptchaNode.loadCaptcha==='function')&&this.genuineCaptchaNode.loadCaptcha()}}function d(bT){return new Promise(bU=>setTimeout(bU,bT))}if(typeof document!=='undefined')if(!customElements.get('genuine-form')){let bV=()=>{if(!document.getElementById('genuine-form')){let bW=document.createElement('template');bW.id='genuine-form';bW.innerHTML=`<script type="module" src="https://cryptng.github.io/genuine-captcha-vanillajs/genuine-captcha.min.js" defer></script>
        <form class="genuine-form-container">
          <slot></slot>
        </form>`;document.body?document.body.prepend(bW):document.addEventListener('DOMContentLoaded',()=>{(document.body&&!document.getElementById('genuine-form'))&&document.body.prepend(bW)})}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',bV):bV();customElements.define('genuine-form',GenuineForm)}function e(bX,bY){let bZ=bY.querySelectorAll('input, select, textarea');for(let cA of bZ){if(!cA.required)continue;if(cA.tagName==='INPUT'){let cB=cA.type.toLowerCase();if(cB==='checkbox')if(!cA.checked)return!1;else if(cB==='radio'){let cC=bY.querySelectorAll(`input[type="radio"][name="${cA.name}"]`),cD=[...cC].some(cE=>cE.checked);if(!cD)return!1}else if(!cA.value.trim())return!1}else if(cA.tagName==='SELECT')if(cA.multiple)if(cA.selectedOptions.length===0)return!1;else if(!cA.value)return!1;else if(cA.tagName==='TEXTAREA')if(!cA.value.trim())return!1}return!0}function f(cF){let cG={},cH=cF.querySelectorAll('input, select, textarea');for(const cI of cH){let cJ=cI.name;if(!cJ)continue;let cK;if(cI.tagName==='INPUT')if(cI.type==='checkbox')cK=(cI.value||'').length>0?(cI.value+':'+cI.checked):cI.checked;else if(cI.type==='radio')if(cI.checked)cK=cI.value;else continue;else cK=cI.value;else if(cI.tagName==='SELECT')cI.multiple?cK=[...cI.selectedOptions].map(opt=>opt.value):cK=cI.value;else cK=cI.value;if(cG.hasOwnProperty(cJ)){!b(cG[cJ])&&(cG[cJ]=[cG[cJ]]);cG[cJ].push(cK)}else cG[cJ]=cK}return cG}export{GenuineForm};
